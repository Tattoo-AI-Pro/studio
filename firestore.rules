/**
 * This ruleset enforces a public, read-only security model for a catalog of AI-generated tattoo designs (AI-Books).
 * The primary goal is to allow public browsing of all content while restricting all write operations until a proper
 * ownership model is defined in the data schema.
 *
 * Core Philosophy:
 * Data is treated as a public catalog. Anyone, authenticated or not, can read any document. All client-side
 * write operations (create, update, delete) are explicitly disabled. This is a secure-by-default posture chosen
 * because the data entities (AiBook, Module, Image) lack an 'ownerId' or 'authorId' field, making it impossible
 * to safely authorize write operations.
 *
 * Data Structure:
 * The data is organized hierarchically to represent the catalog structure:
 * - /ai_books/{aiBookId}: Top-level collection for AI-Book metadata.
 *   - /modules/{moduleId}: Subcollection for modules within an AI-Book.
 *     - /images/{imageId}: Subcollection for images within a module.
 *
 * Key Security Decisions:
 * - Public Read Access: All collections and subcollections are publicly readable (`get`, `list`) to support the catalog browsing feature.
 * - All Writes Denied: All `create`, `update`, and `delete` operations are denied (`if false`). This is a critical security measure
 *   to prevent unauthorized data modification. Rules are marked with a `TODO` to prompt developers to add owner-based
 *   authorization once the data schema is updated with an ownership field.
 * - No User Listing: There are no user-specific collections, so user privacy concerns related to listing are not applicable.
 *
 * Denormalization for Authorization:
 * The current model is simple and does not require denormalization as writes are disallowed. For future implementation
 * of write access, it is strongly recommended to denormalize an `ownerId` field onto the `AiBook` documents.
 * This would allow for simple and performant rules like `allow update: if isOwner(resource.data.ownerId);` without
 * needing costly `get()` calls to other documents.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    // ------------------------------------------------------------------------
    // Collection Rules
    // ------------------------------------------------------------------------

    /**
     * @description Provides public, read-only access to the AI-Book catalog.
     * @path /ai_books/{aiBookId}
     * @allow (get) Any user, authenticated or anonymous, can read an AI-Book document.
     * @deny (create) An authenticated user attempts to create a new AI-Book.
     * @principle Public read-only access. Writes are disabled until a secure ownership model is implemented in the schema.
     */
    match /ai_books/{aiBookId} {
      allow get: if true;
      allow list: if true;
      // CRITICAL: Cannot implement owner-only writes. The 'AiBook' entity is missing an 'ownerId' or 'authorId' field.
      allow create: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow update: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
      allow delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.

      /**
       * @description Provides public, read-only access to AI-Book modules.
       * @path /ai_books/{aiBookId}/modules/{moduleId}
       * @allow (get) Any user, authenticated or anonymous, can read a module document.
       * @deny (update) An authenticated user attempts to update a module's name.
       * @principle Inherits the read-only principle from its parent collection to maintain a consistent security posture.
       */
      match /modules/{moduleId} {
        allow get: if true;
        allow list: if true;
        allow create: if false;
        allow update: if false;
        allow delete: if false;

        /**
         * @description Provides public, read-only access to module images.
         * @path /ai_books/{aiBookId}/modules/{moduleId}/images/{imageId}
         * @allow (list) Any user, authenticated or anonymous, can list all images within a module.
         * @deny (delete) An authenticated user attempts to delete an image.
         * @principle Inherits the read-only principle from its parent collection to maintain a consistent security posture.
         */
        match /images/{imageId} {
          allow get: if true;
          allow list: if true;
          allow create: if false;
          allow update: if false;
          allow delete: if false;
        }
      }
    }
  }
}